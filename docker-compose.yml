services:
  # PostgreSQL-Datenbankservice
  db:
    image: postgres:16-alpine
    container_name: fasiko-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-fasiko_db}
      POSTGRES_USER: ${POSTGRES_USER:-fasiko_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fasiko_pass}
    volumes:
      - pg_data:/var/lib/postgresql/data
    restart: unless-stopped

  # Backend-Anwendung (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: fasiko-backend
    environment:
      APP_NAME: ${APP_NAME:-FaSiKo-Studio Backend}
      ENV_PROFILE: ${ENV_PROFILE:-prod}
      DATABASE_URL: ${DATABASE_URL:-}
      POSTGRES_DB: ${POSTGRES_DB:-fasiko_db}
      POSTGRES_USER: ${POSTGRES_USER:-fasiko_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fasiko_pass}
      OLLAMA_URL: ${OLLAMA_URL:-http://ollama:11434}
      OLLAMA_CHAT_MODEL: ${OLLAMA_CHAT_MODEL:-llama3:8b}
      MODEL_FASIKO_CREATE_70B: ${MODEL_FASIKO_CREATE_70B:-llama3:70b}
      MODEL_GENERAL_8B: ${MODEL_GENERAL_8B:-llama3:8b}
      SEARXNG_URL: ${SEARXNG_URL:-http://searxng:8080}
      WEBSEARCH_MAX_RESULTS: ${WEBSEARCH_MAX_RESULTS:-5}
      WEBSEARCH_TIMEOUT: ${WEBSEARCH_TIMEOUT:-15}
      WEBSEARCH_MAX_QUERY_LENGTH: ${WEBSEARCH_MAX_QUERY_LENGTH:-200}
      UPLOAD_DIR: ${UPLOAD_DIR:-/data/uploads}
      OPENPOINT_DIR: ${OPENPOINT_DIR:-/data/openpoints}
      CHAT_DIR: ${CHAT_DIR:-/data/chat}
      EXPORT_DIR: ${EXPORT_DIR:-/data/exports}
      MAX_UPLOAD_BYTES: ${MAX_UPLOAD_BYTES:-31457280}
      MAX_SOURCES_PER_PROJECT: ${MAX_SOURCES_PER_PROJECT:-50}
      MAX_PARALLEL_JOBS: ${MAX_PARALLEL_JOBS:-3}
      JOB_TIMEOUT: ${JOB_TIMEOUT:-1800}
      API_KEY_ENABLED: ${API_KEY_ENABLED:-false}
      API_KEY: ${API_KEY:-}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-*}
    volumes:
      - backend_data:/data
    depends_on:
      - db
      - ollama
      - searxng
    ports:
      - "8000:8000"
    restart: unless-stopped

  # Ollama-LLM-Service (GPU aktiviert)
  ollama:
    image: ollama/ollama:0.2.7
    container_name: fasiko-ollama
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
      OLLAMA_API_KEY: ollama
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    gpus: all
    restart: unless-stopped

  # SearXNG-Metasuchmaschine f√ºr Webrecherche
  searxng:
    image: searxng/searxng:latest
    container_name: fasiko-searxng
    environment:
      SEARXNG_BASE_URL: ${SEARXNG_URL:-http://searxng:8080}
    ports:
      - "8080:8080"
    volumes:
      - ./searxng/settings.yml:/etc/searxng/settings.yml
      - searxng_data:/var/cache/searxng
    restart: unless-stopped

volumes:
  backend_data:
  pg_data:
  ollama_data:
  searxng_data:
